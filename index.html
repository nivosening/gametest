<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>宗族之書：家族經營遊戲</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
<button onclick="window.location='map.html'" class="primary-btn">地圖系統</button>
  <div class="app">
    <header class="top-bar">
      <div class="title-block">
        <h1>宗族之書：家族經營遊戲</h1>
        <p class="subtitle">你是家主，我是輔佐官。由你決定家族與天下的命運。</p>
        <p class="subtitle small">
          世界年份：<span id="worldYearDisplay"></span>
        </p>
      </div>
      <div class="top-actions">
        <button id="exportBtn" class="btn">匯出存檔</button>
        <button id="importBtn" class="btn">讀取存檔</button>
        <input type="file" id="importFile" accept="application/json" style="display:none;" />
        <button id="resetBtn" class="btn btn-danger">重置遊戲資料</button>
      </div>
    </header>

    <main class="layout">
      <section class="left-col">
        <div class="card">
          <h2 class="card-title">建立家族</h2>
          <form id="familyForm">
            <label>家族名稱
              <input type="text" id="familyName" required />
            </label>
            <div class="form-row">
              <label>家族出身
                <select id="familyOrigin"></select>
              </label>
              <label>所屬區域
                <select id="familyRegion"></select>
              </label>
            </div>
            <div class="form-row">
              <label>主要據點／領地
                <select id="familyTerritory"></select>
              </label>
              <label>備註
                <textarea id="familyNotes"></textarea>
              </label>
            </div>
            <div class="small-row">
              <input type="text" id="newOrigin" placeholder="新增出身" />
              <button type="button" id="addOriginBtn" class="btn btn-small">新增出身</button>
            </div>
            <div class="small-row">
              <input type="text" id="newTerritory" placeholder="新增據點（需先選區域）" />
              <button type="button" id="addTerritoryBtn" class="btn btn-small">新增據點</button>
            </div>
            <div class="card-footer">
              <button type="submit" class="btn btn-primary">加入族譜</button>
            </div>
          </form>
        </div>

        <div class="card">
          <h2 class="card-title">快速建立家族</h2>
          <form id="quickFamilyForm">
            <label>家族姓氏
              <input type="text" id="quickSurname" required />
            </label>
            <div class="form-row">
              <label>成員人數
                <input type="number" id="quickCount" min="1" max="200" required />
              </label>
              <label>年齡區間（最小～最大）
                <div class="inline-input">
                  <input type="number" id="quickAgeMin" min="0" max="120" placeholder="最小" />
                  <span>～</span>
                  <input type="number" id="quickAgeMax" min="0" max="120" placeholder="最大" />
                </div>
              </label>
            </div>
            <div class="form-row">
              <label>出身（選填）
                <select id="quickOrigin"></select>
              </label>
              <label>所屬區域（選填，但指定據點時必填）
                <select id="quickRegion"></select>
              </label>
            </div>
            <label>主要據點／領地（選填）
              <select id="quickTerritory"></select>
            </label>
            <p class="hint">快速建立家族會自動生成成員與年齡與壽命，但不會自動安排婚配。</p>
            <div class="card-footer">
              <button type="submit" class="btn btn-primary">一鍵生成</button>
            </div>

            <div class="card">
              <h2 class="card-title">出身／區域／據點一覽</h2>
              <div id="optionOverview"></div>

              <div class="small-row">
                <input type="text" id="newRole" placeholder="新增身分" />
                <button type="button" id="addRoleBtn" class="btn btn-small">新增身分</button>
              </div>
              <div class="small-row">
                <input type="text" id="newOcc" placeholder="新增職業" />
                <button type="button" id="addOccBtn" class="btn btn-small">新增職業</button>
              </div>
              <div class="small-row">
                <input type="text" id="newRes" placeholder="新增住所" />
                <button type="button" id="addResBtn" class="btn btn-small">新增住所</button>
              </div>
            </div>

          </form>
        </div>

        <div class="card">
          <h2 class="card-title">建立人物</h2>
          <form id="personForm">
            <label>姓名
              <input type="text" id="personName" required />
            </label>
            <div class="form-row">
              <label>年齡或出生年份
                <input type="text" id="personAgeOrBirth" placeholder="20 或 380" />
              </label>
              <label>性別
                <select id="personGender">
                  <option value="">未指定</option>
                  <option value="男">男</option>
                  <option value="女">女</option>
                </select>
              </label>
            </div>
            <div class="form-row">
              <label>身分
                <select id="personRole"></select>
              </label>
              <label>隸屬家族
                <select id="personFamily"></select>
              </label>
            </div>
            <div class="form-row">
              <label>職業
                <select id="personOcc"></select>
              </label>
              <label>住所
                <select id="personRes"></select>
              </label>
            </div>
            <label>備註
              <textarea id="personNotes"></textarea>
            </label>
            <input type="hidden" id="personParentId" />
            <div class="card-footer">
              <button type="button" id="cancelChildModeBtn" class="btn btn-small" style="display:none;">取消以此人為父母建立子女</button>
              <button type="submit" class="btn btn-primary">加入族人</button>
            </div>
          </form>
        </div>

<div class="card card-list">
  <h2 class="card-title">家族列表</h2>
  
   <input id="familySearch" 
      input type="text"
      placeholder="搜尋家族…"
      style="margin-bottom:10px; width:100%;" 
      oninput="renderFamilies()">


  <div id="familyList">
    </div>
        </div>
      </section>

      <section class="right-col">
        <!-- 年份 -->
        <div class="card">
          <h2 class="card-title">時間軸</h2>
          <p>當前世界年份：<span id="timelineYear"></span></p>
          <div class="button-row">
            <button id="yearMinusBtn" class="btn btn-small">-1 年</button>
            <button id="yearPlusBtn" class="btn btn-small">+1 年</button>
          </div>
        </div>

        <!-- 輔佐官 -->
        <div class="card">
          <h2 class="card-title">輔佐官</h2>
          <div id="advisorLog" class="log">
            <p>【輔佐官】家主，請開始建立家族。</p>
          </div>

          <!-- 查詢工具 -->
          <div class="form-row">
            <input type="text" id="advisorSearchName" placeholder="輸入姓名調取人物" />
            <button id="advisorSearchBtn" class="btn btn-small">調取人物</button>
          </div>

          <div class="form-row">
            <select id="advisorLocation"></select>
            <button id="advisorLocationBtn" class="btn btn-small">調取地點資料</button>
          </div>

          <div class="form-row">
            <input type="number" id="ageMin" placeholder="最小年齡" />
            <input type="number" id="ageMax" placeholder="最大年齡" />
            <button id="advisorAgeBtn" class="btn btn-small">調取年齡段</button>
          </div>

          <!-- 指令欄真正修正點 -->
          <form id="advisorCommandForm">
            <textarea id="advisorCommand" rows="3" placeholder="可輸入指令：查人 某某、查地 中原、結為連理 A B..."></textarea>
            <div class="button-row">
              <button type="submit" class="btn btn-primary btn-small">送出指令</button>
              <button id="worldSummaryBtn" type="button" class="btn btn-small">天下總覽</button>
            </div>
          </form>
        </div>

        <!-- 事件 -->
        <div class="card">
          <h2 class="card-title">事件系統</h2>
          <div class="form-row">
            <label>事件類型
              <select id="eventType">
                <option value="random">隨機事件</option>
                <option value="marriage">聯姻提親</option>
                <option value="birth">子嗣誕生預兆</option>
                <option value="conflict">內鬥糾紛</option>
                <option value="alliance">結盟合作</option>
                <option value="disaster">災異風波</option>
                <option value="inheritance">繼承與分家</option>
              </select>
            </label>
            <label>事件區域
              <select id="eventRegion"></select>
            </label>
          </div>
          <button id="triggerEventBtn" class="btn btn-primary">觸發事件</button>
        </div>

        <!-- 區域 -->
        <div class="card">
          <h2 class="card-title">世界區域與勢力</h2>
          <div id="regionOverview"></div>
        </div>

        <!-- 詳情 -->
        <div class="card">
          <h2 class="card-title">家族詳情</h2>
          <div id="familyDetail" class="detail">
            <p class="hint">請從左側家族列表中選擇一個家族。</p>
          </div>
        </div>

        <div class="card">
          <h2 class="card-title">人物詳情</h2>
          <div id="personDetail" class="detail">
            <p class="hint">請從家族詳情中的成員列表點選一人。</p>

<div id="personEditActionBox" class="detail-section" style="margin-top: 10px;">
    <button id="editPersonBtn" class="btn btn-secondary" style="display:none;">編輯此人物</button>
</div>

<div id="personEditForm" class="detail-section hidden">
    </div>

<div id="addSpouseBox" class="detail-section">
    </div>

<div id="personContent">
    </div>
    
</div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- 事件視窗（修正版） -->
  <div id="eventModal" class="modal hidden">
    <div class="modal-content">
      <h3>事件確認</h3>
      <div id="eventText" class="modal-body"></div>
      <label>家主決定
        <select id="eventDecision"></select>
      </label>
      <div class="button-row right">
        <button id="cancelEventBtn" class="btn btn-small">取消</button>
        <button id="resolveEventBtn" class="btn btn-primary btn-small">執行</button>
      </div>
    </div>
  </div>

  <script src="js/game.js"></script>

<!-- Small Parent Selection Dialog -->
<div id="parentSelectDialog" style="position:fixed; bottom:20px; right:20px; background:white;
border:1px solid #ccc; padding:15px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.2);
display:none; z-index:9999;">
  <div id="parentSelectText" style="margin-bottom:10px;">選擇另一位父母：</div>
  <div id="parentSelectButtons" style="display:flex; flex-direction:column; gap:6px;"></div>
  <button onclick="closeParentSelectDialog()">關閉</button>
</div>
<!-- === 小型第二父母選擇對話框 === -->
<div id="parentSelectDialog" 
     style="
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: white;
        border: 1px solid #ccc;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        z-index: 99999;
        display: none;
        max-width: 260px;
     ">
  <div id="parentSelectText" style="margin-bottom: 10px;">
    選擇第二位父母：
  </div>

  <div id="parentSelectButtons" 
       style="display: flex; flex-direction: column; gap: 6px; margin-bottom: 10px;">
  </div>

  <button onclick="closeParentSelectDialog()" 
          style="padding: 6px 10px; border: 1px solid #666; border-radius: 6px;">
    關閉
  </button>
</div>

</body>
</html>
